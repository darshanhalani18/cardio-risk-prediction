import { Download, CheckCircle, AlertTriangle, AlertOctagon, Activity, RotateCcw } from "lucide-react";
import { cn } from "@/lib/utils";
import jsPDF from "jspdf";
import { motion } from "framer-motion";

interface ResultCardProps {
  prediction: number; // 0 or 1
  riskPercent: number;
  onReset?: () => void;
}

export function ResultCard({ prediction, riskPercent, onReset }: ResultCardProps) {
  // Determine risk level based on percentage using the requested colors
  const getRiskDetails = (percent: number) => {
      if (percent < 30) return { 
          label: "Low Risk", 
          desc: "Your metrics are within a healthy range.",
          action: "Maintain your healthy lifestyle with regular exercise and balanced diet.",
          color: "text-emerald-400", 
          bg: "bg-emerald-500", 
          border: "border-emerald-900",
      };
      if (percent < 70) return { 
          label: "Moderate Risk", 
          desc: "Signs of potential risk factors detected.",
          action: "Consider monitoring your blood pressure and consulting a doctor for advice.",
          color: "text-amber-400", 
          bg: "bg-amber-500", 
          border: "border-amber-900",
      };
      return { 
          label: "High Risk", 
          desc: "Strong indicators of cardiovascular disease risk.",
          action: "We strongly recommend scheduling a comprehensive check-up with a cardiologist immediately.",
          color: "text-rose-400", 
          bg: "bg-rose-500", 
          border: "border-rose-900",
      };
  };

  const riskDetails = getRiskDetails(riskPercent);

  const generatePDF = () => {
    const doc = new jsPDF();
    const date = new Date().toLocaleString();

    // Header
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.setTextColor(30, 41, 59); // Slate-800
    doc.text("Cardiovascular Risk Report", 20, 25);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(100, 116, 139); // Slate-500
    doc.text(`Generated on: ${date}`, 20, 35);
    
    // Line
    doc.setDrawColor(226, 232, 240); // Slate-200
    doc.setLineWidth(1);
    doc.line(20, 40, 190, 40);

    // Box for Result
    doc.setFillColor(248, 250, 252); // Slate-50
    doc.rect(20, 50, 170, 40, "F");
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(71, 85, 105); // Slate-600
    doc.text("Assessment Result", 30, 65);

    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text(`${riskDetails.label} (${riskPercent}%)`, 30, 75);
    
    doc.setFontSize(10);
    doc.setTextColor(100, 116, 139); 
    doc.text(`Model: Random Forest Classifier`, 130, 75);

    // Details Section
    doc.setFontSize(12);
    doc.setTextColor(30, 41, 59);
    doc.text("Clinical Interpretation:", 20, 110);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(51, 65, 85);
    doc.text(doc.splitTextToSize(riskDetails.desc, 170), 20, 118);
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(30, 41, 59);
    doc.text("Recommended Action:", 20, 135);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(51, 65, 85);
    doc.text(doc.splitTextToSize(riskDetails.action, 170), 20, 143);

    // Disclaimer Footer
    doc.setDrawColor(226, 232, 240);
    doc.line(20, 260, 190, 260);
    
    doc.setFontSize(8);
    doc.setTextColor(148, 163, 184); // Slate-400
    doc.text("DISCLAIMER: This report is generated by an AI model for educational purposes only using a Random Forest algorithm (~73% accuracy). It is NOT a medical diagnosis. Please consult a qualified healthcare provider.", 20, 270, { maxWidth: 170 });

    doc.save("cardio-risk-report.pdf");
  };

  return (
    <motion.div 
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      className={cn(
        "relative overflow-hidden rounded-3xl border p-8 shadow-xl bg-slate-900",
        riskDetails.border
      )}
    >
      
      <div className="relative z-10 flex flex-col items-center text-center">
        
        {/* Gauge Chart Visual */}
        <div className="mb-8 relative">
             <div className="relative w-56 h-32 overflow-hidden">
                <div className="absolute top-0 left-0 w-56 h-56 rounded-full border-[20px] border-slate-800" />
                <motion.div 
                    initial={{ rotate: -45 }}
                    animate={{ rotate: -45 + (riskPercent * 1.8) }}
                    transition={{ duration: 1.5, ease: "easeOut" }}
                    className={cn("absolute top-0 left-0 w-56 h-56 rounded-full border-[20px] border-transparent", 
                    riskDetails.label === "High Risk" ? "border-t-rose-500 border-r-rose-500" : (riskDetails.label === "Moderate Risk" ? "border-t-amber-500 border-r-amber-500" : "border-t-emerald-500 border-r-emerald-500"))}
                />
            </div>
            
            <div className="absolute bottom-0 left-1/2 -translate-x-1/2 flex flex-col items-center">
                 <span className={cn("text-6xl font-extrabold tracking-tighter", riskDetails.color)}>
                  {riskPercent}%
                 </span>
                 <span className="text-xs text-slate-400 uppercase tracking-widest font-bold mt-2">Probability</span>
            </div>
        </div>

        <h3 className={cn("text-3xl font-bold mb-3", riskDetails.color)}>
            {riskDetails.label}
        </h3>
        
        <p className="text-slate-400 max-w-md mx-auto leading-relaxed mb-6 font-medium">
            {riskDetails.desc}
        </p>

        {/* New Risk Spectrum Bar */}
        <div className="w-full mb-8">
            <div className="flex justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                <span>Low Risk</span>
                <span>Moderate</span>
                <span>High Risk</span>
            </div>
            <div className="h-3 w-full bg-slate-800 rounded-full overflow-hidden relative">
                {/* Background Regions */}
                <div className="absolute left-0 w-[30%] h-full bg-emerald-900/30" />
                <div className="absolute left-[30%] w-[40%] h-full bg-amber-900/30" />
                <div className="absolute left-[70%] w-[30%] h-full bg-rose-900/30" />
                
                {/* Indicator Marker */}
                <motion.div 
                    initial={{ left: "0%" }}
                    animate={{ left: `${Math.min(riskPercent, 100)}%` }}
                    transition={{ duration: 1.5, ease: "easeOut" }}
                    className="absolute top-0 h-full w-1.5 bg-white shadow-[0_0_10px_rgba(0,0,0,0.5)] z-10"
                />
            </div>
        </div>

        <div className="w-full bg-slate-800/50 rounded-2xl p-6 mb-8 text-left border border-slate-800">
             <h4 className="font-bold text-white mb-2 flex items-center gap-2">
                <Activity className="w-4 h-4 text-blue-500" />
                Recommended Action
             </h4>
             <p className="text-sm text-slate-400 leading-relaxed font-medium">
               {riskDetails.action}
             </p>
        </div>

        <div className="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
          <button 
            onClick={generatePDF}
            className="inline-flex items-center justify-center rounded-xl bg-white px-6 py-3.5 text-sm font-bold text-slate-900 shadow-lg hover:bg-slate-200 transition-all hover:scale-105 w-full sm:w-auto"
          >
            <Download className="mr-2 h-4 w-4" />
            Download PDF Report
          </button>
          
          {onReset && (
            <button 
              onClick={onReset}
              className="inline-flex items-center justify-center rounded-xl border-2 border-slate-700 bg-slate-800 px-6 py-3.5 text-sm font-bold text-slate-200 shadow-lg hover:bg-slate-700 transition-all hover:scale-105 w-full sm:w-auto"
            >
              <RotateCcw className="mr-2 h-4 w-4" />
              Reset & Check Again
            </button>
          )}
        </div>

         <div className="mt-6 text-xs text-slate-400 font-medium">
             Analysis performed using <strong>Random Forest Classifier</strong> (~73% Accuracy)
        </div>
      </div>
    </motion.div>
  );
}
